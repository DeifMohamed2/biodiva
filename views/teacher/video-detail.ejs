<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تفاصيل الفيديو - منصة تعليمية</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/teacher-modern.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
    }
    
    .table-container .teacher-table {
      margin-bottom: 0;
    }
    
    .table-container .teacher-table thead th {
      position: sticky;
      top: 0;
      background-color: var(--surface-color);
      z-index: 10;
      box-shadow: 0 1px 0 var(--border-color);
    }
    
    .stats-card {
      background: var(--surface-color);
      border-radius: var(--radius-md);
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      height: 100%;
    }
    
    .stats-icon {
      width: 50px;
      height: 50px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stats-value {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .stats-label {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .tab-container {
      margin-bottom: 1rem;
    }
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .tab.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .no-data-container {
      text-align: center;
      padding: 3rem 2rem;
    }
    
    .no-data-icon {
      font-size: 3rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="teacher-container">
    <!-- Sidebar -->
    <%- include('./partials/nav.ejs') %>
    
    <!-- Main Content -->
    <main class="teacher-main">
      <!-- Header -->
      <header class="teacher-header">
        <div class="header-left">
          <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </button>
          <h1 class="page-title">تفاصيل الفيديو</h1>
        </div>
        
        <div class="header-right">
          <div style="display: flex; gap: 0.5rem;">
            <a href="/teacher/videos/<%= video._id %>/edit" class="btn btn-primary">
              <i class="fas fa-edit"></i>
              تعديل
            </a>
            <button class="btn btn-danger delete-video" data-id="<%= video._id %>">
              <i class="fas fa-trash"></i>
              حذف
            </button>
            <a href="/teacher/chapters/<%= chapter._id %>" class="btn btn-outline">
              <i class="fas fa-arrow-right"></i>
              العودة للفصل
            </a>
          </div>
        </div>
      </header>
      
      <!-- Content -->
      <div class="teacher-content">
        <div class="form-grid">
          <!-- Video Player -->
          <div class="form-section">
            <h3 class="section-title"><%= video.videoTitle || video.lectureName %></h3>
            
            <div style="margin-bottom: 1.5rem;">
              <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: var(--radius-lg);">
                <iframe src="<%= video.videoURL %>" allowfullscreen style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"></iframe>
              </div>
            </div>
            
            <!-- Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
              <div class="stats-card">
                <div class="stats-icon" style="background: var(--info-color);">
                  <i class="fas fa-eye" style="font-size: 1.5rem; color: white;"></i>
                </div>
                <div>
                  <h4 class="stats-value"><%= totalWatches || 0 %></h4>
                  <p class="stats-label">عدد المشاهدات</p>
                </div>
              </div>
              
              <div class="stats-card">
                <div class="stats-icon" style="background: var(--success-color);">
                  <i class="fas fa-users" style="font-size: 1.5rem; color: white;"></i>
                </div>
                <div>
                  <h4 class="stats-value"><%= uniqueViewers || 0 %></h4>
                  <p class="stats-label">المشاهدين الفريدين</p>
                </div>
              </div>
              
              <div class="stats-card">
                <div class="stats-icon" style="background: var(--primary-color);">
                  <i class="fas fa-chart-line" style="font-size: 1.5rem; color: white;"></i>
                </div>
                <div>
                  <h4 class="stats-value"><%= uniqueViewers > 0 ? Math.round((totalWatches / uniqueViewers) * 10) / 10 : 0 %></h4>
                  <p class="stats-label">متوسط المشاهدات لكل طالب</p>
                </div>
              </div>
              
              <div class="stats-card">
                <div class="stats-icon" style="background: var(--warning-color);">
                  <i class="fas fa-user-slash" style="font-size: 1.5rem; color: white;"></i>
                </div>
                <div>
                  <h4 class="stats-value" id="unwatchedCount">0</h4>
                  <p class="stats-label">لم يشاهدوا بعد</p>
                </div>
              </div>
            </div>
            
            <!-- Video Details -->
            <div class="dashboard-card" style="margin-bottom: 1.5rem;">
              <h3 class="section-title">تفاصيل الفيديو</h3>
              
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div>
                  <div style="margin-bottom: 1rem;">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">نوع الفيديو</p>
                    <p style="margin: 0; font-weight: 600;">
                      <% if (videoType === 'lecture') { %>
                        <i class="fas fa-chalkboard-teacher" style="color: var(--info-color); margin-left: 0.5rem;"></i> محاضرة
                      <% } else if (videoType === 'summary') { %>
                        <i class="fas fa-file-alt" style="color: var(--accent-color); margin-left: 0.5rem;"></i> ملخص
                      <% } else if (videoType === 'solving') { %>
                        <i class="fas fa-tasks" style="color: var(--success-color); margin-left: 0.5rem;"></i> حل تمارين
                      <% } %>
                    </p>
                  </div>
                  
                  <div style="margin-bottom: 1rem;">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">حالة الدفع</p>
                    <p style="margin: 0; font-weight: 600;">
                      <% if (video.paymentStatus === 'Free') { %>
                        <i class="fas fa-unlock" style="color: var(--success-color); margin-left: 0.5rem;"></i> مجاني
                      <% } else { %>
                        <i class="fas fa-lock" style="color: var(--warning-color); margin-left: 0.5rem;"></i> مدفوع
                        <% if (video.videoPrice) { %>
                          (<%= video.videoPrice %> جنيه)
                        <% } %>
                      <% } %>
                    </p>
                  </div>
                  
                  <div style="margin-bottom: 1rem;">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">المتطلبات المسبقة</p>
                    <p style="margin: 0; font-weight: 600;">
                      <% if (!video.prerequisites) { %>
                        <i class="fas fa-check-circle" style="color: var(--success-color); margin-left: 0.5rem;"></i> بدون متطلبات
                      <% } else if (video.prerequisites === 'WithExam') { %>
                        <i class="fas fa-clipboard-check" style="color: var(--info-color); margin-left: 0.5rem;"></i> مع اختبار
                      <% } else if (video.prerequisites === 'WithHw') { %>
                        <i class="fas fa-book" style="color: var(--accent-color); margin-left: 0.5rem;"></i> مع واجب
                      <% } else if (video.prerequisites === 'WithExamaAndHw') { %>
                        <i class="fas fa-tasks" style="color: var(--warning-color); margin-left: 0.5rem;"></i> مع اختبار وواجب
                      <% } %>
                    </p>
                  </div>
                </div>
                
                <div>
                  <div style="margin-bottom: 1rem;">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">عدد المشاهدات المسموح بها</p>
                    <p style="margin: 0; font-weight: 600;">
                      <i class="fas fa-play-circle" style="color: var(--primary-color); margin-left: 0.5rem;"></i> <%= video.videoAllowedAttemps || 3 %> مشاهدات
                    </p>
                  </div>
                  
                  <% if (video.PDFURL) { %>
                    <div style="margin-bottom: 1rem;">
                      <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">ملف PDF</p>
                      <p style="margin: 0; font-weight: 600;">
                        <i class="fas fa-file-pdf" style="color: var(--danger-color); margin-left: 0.5rem;"></i>
                        <a href="<%= video.PDFURL %>" target="_blank" style="color: var(--primary-color); text-decoration: none;">عرض الملف</a>
                      </p>
                    </div>
                  <% } %>
                  
                  <div style="margin-bottom: 1rem;">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">تاريخ الإنشاء</p>
                    <p style="margin: 0; font-weight: 600;">
                      <i class="fas fa-calendar-alt" style="color: var(--secondary-color); margin-left: 0.5rem;"></i> <%= new Date(video.createdAt).toLocaleString('ar-EG') %>
                    </p>
                  </div>
                </div>
              </div>
              
              <% if (video.videoDescription) { %>
                <div style="margin-top: 1.5rem;">
                  <p style="margin: 0 0 0.5rem 0; color: var(--text-secondary); font-size: 0.875rem;">الوصف</p>
                  <p style="margin: 0; padding: 1rem; background: var(--surface-color); border-radius: var(--radius-md);">
                    <%= video.videoDescription %>
                  </p>
                </div>
              <% } %>
            </div>
          </div>
        </div>
        
        <!-- Students Stats Tabs -->
        <div class="dashboard-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 class="section-title" style="margin: 0;">إحصائيات المشاهدة</h3>
            
            <div class="tabs">
              <div class="tab active" data-tab="watched">الطلاب الذين شاهدوا</div>
              <div class="tab" data-tab="unwatched">الطلاب الذين لم يشاهدوا</div>
              <div class="tab" data-tab="homework">الواجبات المسلمة</div>
            </div>
          </div>
          
          <!-- Tab Content -->
          <div class="tab-content active" id="watched-tab">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="watchedSearch" placeholder="البحث بالكود أو رقم الهاتف..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; width: 250px;">
                <button id="clearWatchedSearch" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <button type="button" class="btn btn-outline" id="exportWatchedBtn">
                <i class="fas fa-file-excel"></i>
                تصدير Excel
              </button>
            </div>
            
            <% if (studentsStats && studentsStats.filter(s => s.numberOfWatches > 0).length > 0) { %>
              <div class="table-container">
                <table class="teacher-table" id="watched-table">
                  <thead>
                    <tr>
                      <th style="width: 5%;">#</th>
                      <th style="width: 15%;">الطالب</th>
                      <th style="width: 8%;">الكود</th>
                      <th style="width: 8%;">الصف</th>
                      <th style="width: 12%;">رقم الهاتف</th>
                      <th style="width: 12%;">هاتف ولي الأمر</th>
                      <th style="width: 8%;">المشاهدات</th>
                      <th style="width: 8%;">المتبقي</th>
                      <th style="width: 10%;">آخر مشاهدة</th>
                      <th style="width: 8%;">حالة الدفع</th>
                      <th style="width: 10%;">الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% let watchedStudents = studentsStats.filter(s => s.numberOfWatches > 0); %>
                    <% watchedStudents.forEach((student, index) => { %>
                      <tr>
                        <td><%= index + 1 %></td>
                        <td><%= student.studentName %></td>
                        <td><%= student.studentCode %></td>
                        <td><%= student.grade %></td>
                        <td><%= student.phone %></td>
                        <td><%= student.parentPhone %></td>
                        <td><%= student.numberOfWatches %></td>
                        <td><%= student.videoAllowedAttemps - student.numberOfWatches %></td>
                        <td><%= student.lastWatch ? new Date(student.lastWatch).toLocaleString('ar-EG') : 'غير متوفر' %></td>
                        <td>
                          <span class="status-badge <%= student.purchaseStatus ? 'active' : 'pending' %>">
                            <%= student.purchaseStatus ? 'مدفوع' : 'غير مدفوع' %>
                          </span>
                        </td>
                        <td>
                          <button class="btn btn-sm btn-primary increase-watches" 
                                  data-student-id="<%= student.studentId %>" 
                                  data-student-name="<%= student.studentName %>"
                                  data-current-attempts="<%= student.videoAllowedAttemps %>">
                            <i class="fas fa-plus"></i>
                            زيادة المشاهدات
                          </button>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="no-data-container">
                <i class="fas fa-video-slash no-data-icon"></i>
                <h4 style="margin-bottom: 0.5rem;">لم يشاهد أي طالب هذا الفيديو بعد</h4>
                <p style="color: var(--text-secondary);">سيظهر هنا إحصائيات المشاهدة عندما يبدأ الطلاب في مشاهدة الفيديو</p>
              </div>
            <% } %>
          </div>
          
          <div class="tab-content" id="unwatched-tab">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="unwatchedSearch" placeholder="البحث بالكود أو رقم الهاتف..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; width: 250px;">
                <button id="clearUnwatchedSearch" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <button type="button" class="btn btn-outline" id="exportUnwatchedBtn">
                <i class="fas fa-file-excel"></i>
                تصدير Excel
              </button>
            </div>
            
            <% if (studentsStats && studentsStats.filter(s => s.numberOfWatches === 0).length > 0) { %>
              <div class="table-container">
                <table class="teacher-table" id="unwatched-table">
                  <thead>
                    <tr>
                      <th style="width: 5%;">#</th>
                      <th style="width: 15%;">الطالب</th>
                      <th style="width: 8%;">الكود</th>
                      <th style="width: 8%;">الصف</th>
                      <th style="width: 12%;">رقم الهاتف</th>
                      <th style="width: 12%;">هاتف ولي الأمر</th>
                      <th style="width: 10%;">المشاهدات المتاحة</th>
                      <th style="width: 10%;">حالة الدفع</th>
                      <th style="width: 20%;">الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% let unwatchedStudents = studentsStats.filter(s => s.numberOfWatches === 0); %>
                    <% unwatchedStudents.forEach((student, index) => { %>
                      <tr>
                        <td><%= index + 1 %></td>
                        <td><%= student.studentName %></td>
                        <td><%= student.studentCode %></td>
                        <td><%= student.grade %></td>
                        <td><%= student.phone %></td>
                        <td><%= student.parentPhone %></td>
                        <td><%= student.videoAllowedAttemps %></td>
                        <td>
                          <span class="status-badge <%= student.purchaseStatus ? 'active' : 'pending' %>">
                            <%= student.purchaseStatus ? 'مدفوع' : 'غير مدفوع' %>
                          </span>
                        </td>
                        <td>
                          <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-outline send-reminder" 
                                    data-student="<%= student.studentName %>" 
                                    data-code="<%= student.studentCode %>">
                              <i class="fas fa-bell"></i>
                              تذكير
                            </button>
                            <button class="btn btn-sm btn-primary increase-watches" 
                                    data-student-id="<%= student.studentId %>" 
                                    data-student-name="<%= student.studentName %>"
                                    data-current-attempts="<%= student.videoAllowedAttemps %>">
                              <i class="fas fa-plus"></i>
                              زيادة المشاهدات
                            </button>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="no-data-container">
                <i class="fas fa-check-circle no-data-icon" style="color: var(--success-color);"></i>
                <h4 style="margin-bottom: 0.5rem;">جميع الطلاب شاهدوا الفيديو!</h4>
                <p style="color: var(--text-secondary);">لا يوجد طلاب لم يشاهدوا الفيديو بعد</p>
              </div>
            <% } %>
          </div>
          
          <!-- Homework Submissions Tab -->
          <div class="tab-content" id="homework-tab">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="text" id="homeworkSearch" placeholder="البحث بالاسم أو الكود..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; width: 250px;">
                  <button id="clearHomeworkSearch" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <button type="button" class="btn btn-outline" id="exportHomeworkBtn">
                  <i class="fas fa-file-excel"></i>
                  تصدير Excel
                </button>
              </div>
              
              <% if (homeworkSubmissions && homeworkSubmissions.length > 0) { %>
                <div class="table-container">
                  <table class="teacher-table" id="homework-table">
                    <thead>
                      <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 15%;">اسم الطالب</th>
                        <th style="width: 8%;">الكود</th>
                        <th style="width: 8%;">الصف</th>
                        <th style="width: 10%;">تاريخ التسليم</th>
                        <th style="width: 8%;">الحالة</th>
                        <th style="width: 10%;">الملفات</th>
                        <th style="width: 15%;">ملاحظات الطالب</th>
                        <th style="width: 15%;">ملاحظات المراجعة</th>
                        <th style="width: 15%;">الإجراءات</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% homeworkSubmissions.forEach((submission, index) => { %>
                        <tr>
                          <td><%= index + 1 %></td>
                          <td><%= submission.studentName %></td>
                          <td><%= submission.studentCode %></td>
                          <td><%= submission.studentGrade || 'غير محدد' %></td>
                          <td><%= new Date(submission.submittedAt).toLocaleString('ar-EG') %></td>
                          <td>
                            <span class="status-badge <%= submission.status === 'approved' ? 'active' : submission.status === 'pending' ? 'pending' : 'rejected' %>">
                              <%= submission.status === 'approved' ? 'مقبول' : submission.status === 'pending' ? 'في الانتظار' : 'مرفوض' %>
                            </span>
                          </td>
                          <td>
                            <% if (submission.files && submission.files.length > 0) { %>
                              <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <% submission.files.forEach(function(file) { %>
                                  <a href="<%= file.url %>" target="_blank" style="color: var(--primary-color); font-size: 0.75rem;">
                                    <i class="fas fa-file"></i> <%= file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name %>
                                  </a>
                                <% }); %>
                              </div>
                            <% } else { %>
                              <span style="color: var(--text-secondary);">لا توجد ملفات</span>
                            <% } %>
                          </td>
                          <td>
                            <% if (submission.notes) { %>
                              <span style="font-size: 0.75rem;" title="<%= submission.notes %>">
                                <%= submission.notes.length > 30 ? submission.notes.substring(0, 30) + '...' : submission.notes %>
                              </span>
                            <% } else { %>
                              <span style="color: var(--text-secondary);">لا توجد ملاحظات</span>
                            <% } %>
                          </td>
                          <td>
                            <% if (submission.reviewNotes) { %>
                              <span style="font-size: 0.75rem;" title="<%= submission.reviewNotes %>">
                                <%= submission.reviewNotes.length > 30 ? submission.reviewNotes.substring(0, 30) + '...' : submission.reviewNotes %>
                              </span>
                            <% } else { %>
                              <span style="color: var(--text-secondary);">لا توجد ملاحظات</span>
                            <% } %>
                          </td>
                          <td>
                            <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                              <% if (submission.status === 'pending') { %>
                                <button class="btn btn-sm btn-success approve-homework" 
                                        data-submission-id="<%= submission._id %>" 
                                        data-student-name="<%= submission.studentName %>"
                                        data-student-id="<%= submission.studentId %>"
                                        title="قبول الواجب">
                                  <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger reject-homework" 
                                        data-submission-id="<%= submission._id %>" 
                                        data-student-name="<%= submission.studentName %>"
                                        data-student-id="<%= submission.studentId %>"
                                        title="رفض الواجب">
                                  <i class="fas fa-times"></i>
                                </button>
                              <% } else if (submission.status === 'approved') { %>
                                <button class="btn btn-sm btn-warning review-homework" 
                                        data-submission-id="<%= submission._id %>" 
                                        data-student-name="<%= submission.studentName %>"
                                        data-current-notes="<%= submission.reviewNotes || '' %>"
                                        title="تعديل ملاحظات المراجعة">
                                  <i class="fas fa-edit"></i>
                                </button>
                              <% } else { %>
                                <button class="btn btn-sm btn-primary approve-homework" 
                                        data-submission-id="<%= submission._id %>" 
                                        data-student-name="<%= submission.studentName %>"
                                        data-student-id="<%= submission.studentId %>"
                                        title="قبول الواجب">
                                  <i class="fas fa-check"></i>
                                </button>
                              <% } %>
                              <button class="btn btn-sm btn-outline view-homework-details" 
                                      data-submission-id="<%= submission._id %>"
                                      title="عرض التفاصيل">
                                <i class="fas fa-eye"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="no-data-container">
                  <i class="fas fa-tasks no-data-icon"></i>
                  <h4 style="margin-bottom: 0.5rem;">لا توجد واجبات مسلمة بعد</h4>
                  <p style="color: var(--text-secondary);">ستظهر هنا الواجبات عندما يقوم الطلاب بتسليمها</p>
                </div>
              <% } %>
            </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">تأكيد الحذف</h3>
        <button class="modal-close" onclick="closeDeleteModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger-color); margin-bottom: 1rem;"></i>
          <p>هل أنت متأكد من حذف الفيديو "<%= video.videoTitle || video.lectureName %>"؟</p>
          <p style="color: var(--text-secondary); font-size: 0.875rem;">لا يمكن التراجع عن هذا الإجراء</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeDeleteModal()">إلغاء</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">حذف</button>
      </div>
    </div>
  </div>
  
  <!-- Increase Watches Modal -->
  <div class="modal-overlay" id="increaseWatchesModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">زيادة عدد المشاهدات</h3>
        <button class="modal-close" onclick="closeIncreaseWatchesModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 1.5rem;">
          <p>إضافة مشاهدات للطالب: <strong id="studentNameDisplay"></strong></p>
          
          <div class="form-group">
            <label class="form-label">عدد المشاهدات الإضافية</label>
            <input type="number" class="form-input" id="additionalWatches" min="1" value="1">
          </div>
          
          <div class="form-group">
            <label class="form-label">عدد المشاهدات الحالي</label>
            <input type="text" class="form-input" id="currentWatches" readonly>
          </div>
          
          <div class="form-group">
            <label class="form-label">العدد الإجمالي بعد الزيادة</label>
            <input type="text" class="form-input" id="totalWatches" readonly>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeIncreaseWatchesModal()">إلغاء</button>
        <button class="btn btn-primary" id="confirmIncreaseBtn">تأكيد</button>
      </div>
    </div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Sidebar Toggle
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      document.getElementById('sidebar').classList.toggle('collapsed');
    });
    
    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        
        // Remove active class from all tabs and contents
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // Add active class to current tab and content
        this.classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    
    // Update unwatched count
    const unwatchedCount = document.getElementById('unwatchedCount');
    unwatchedCount.textContent = '<%= unwatchedCount %>';
    
    // Export to Excel functions
    function exportTableToExcel(tableId, fileName) {
      const table = document.getElementById(tableId);
      if (!table) return;
      
      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      
      // Convert table to worksheet
      const ws = XLSX.utils.table_to_sheet(table, {raw: true});
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      
      // Generate Excel file and trigger download
      XLSX.writeFile(wb, `${fileName}.xlsx`);
    }
    
    // Export watched students
    document.getElementById('exportWatchedBtn').addEventListener('click', function() {
      exportTableToExcel('watched-table', 'students_watched_video_<%= video._id %>');
    });
    
    // Export unwatched students
    document.getElementById('exportUnwatchedBtn').addEventListener('click', function() {
      exportTableToExcel('unwatched-table', 'students_unwatched_video_<%= video._id %>');
    });
    
    // Send reminder functionality
    const reminderButtons = document.querySelectorAll('.send-reminder');
    reminderButtons.forEach(button => {
      button.addEventListener('click', function() {
        const studentName = this.getAttribute('data-student');
        const studentCode = this.getAttribute('data-code');
        
        // Show temporary notification
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-check"></i> تم';
        this.disabled = true;
        
        setTimeout(() => {
          this.innerHTML = originalText;
          this.disabled = false;
        }, 3000);
        
        // In a real implementation, you would send an AJAX request to the server
        console.log(`Sending reminder to ${studentName} (${studentCode})`);
      });
    });
    
    // Increase watches functionality
    let currentStudentId = null;
    const increaseWatchesButtons = document.querySelectorAll('.increase-watches');
    const additionalWatchesInput = document.getElementById('additionalWatches');
    const currentWatchesInput = document.getElementById('currentWatches');
    const totalWatchesInput = document.getElementById('totalWatches');
    
    function showIncreaseWatchesModal() {
      document.getElementById('increaseWatchesModal').classList.add('show');
    }
    
    function closeIncreaseWatchesModal() {
      document.getElementById('increaseWatchesModal').classList.remove('show');
    }
    
    // Update total watches when additional watches input changes
    additionalWatchesInput.addEventListener('input', function() {
      const additional = parseInt(this.value) || 0;
      const current = parseInt(currentWatchesInput.value) || 0;
      totalWatchesInput.value = current + additional;
    });
    
    increaseWatchesButtons.forEach(button => {
      button.addEventListener('click', function() {
        const studentId = this.getAttribute('data-student-id');
        const studentName = this.getAttribute('data-student-name');
        const currentAttempts = parseInt(this.getAttribute('data-current-attempts')) || 0;
        
        // Set current student ID for the confirmation button
        currentStudentId = studentId;
        
        // Update modal content
        document.getElementById('studentNameDisplay').textContent = studentName;
        currentWatchesInput.value = currentAttempts;
        additionalWatchesInput.value = 1;
        totalWatchesInput.value = currentAttempts + 1;
        
        // Show modal
        showIncreaseWatchesModal();
      });
    });
    
    // Handle confirm increase button click
    document.getElementById('confirmIncreaseBtn').addEventListener('click', function() {
      if (!currentStudentId) return;
      
      const additionalWatches = parseInt(additionalWatchesInput.value) || 1;
      
      // Disable button and show loading state
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المعالجة...';
      
      fetch(`/teacher/videos/<%= video._id %>/increase-watches/${currentStudentId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ additionalWatches })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Close modal
          closeIncreaseWatchesModal();
          
          // Show success message
          alert(data.message);
          
          // Reload page to reflect changes
          location.reload();
        } else {
          alert(`حدث خطأ: ${data.message}`);
          this.disabled = false;
          this.innerHTML = 'تأكيد';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء زيادة عدد المشاهدات');
        this.disabled = false;
        this.innerHTML = 'تأكيد';
      });
    });
    
    // Delete video functionality
    const deleteBtn = document.querySelector('.delete-video');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    function showDeleteModal() {
      document.getElementById('deleteModal').classList.add('show');
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('show');
    }
    
    deleteBtn.addEventListener('click', function() {
      const videoId = this.getAttribute('data-id');
      showDeleteModal();
      
      confirmDeleteBtn.onclick = function() {
        fetch(`/teacher/videos/${videoId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = '/teacher/chapters/<%= chapter._id %>';
          } else {
            alert('حدث خطأ أثناء حذف الفيديو');
            closeDeleteModal();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('حدث خطأ أثناء حذف الفيديو');
          closeDeleteModal();
        });
      };
    });
    
    // Close modal when clicking outside
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('show');
        }
      });
    });
    
    // Search functionality for watched students
    const watchedSearchInput = document.getElementById('watchedSearch');
    const clearWatchedSearchBtn = document.getElementById('clearWatchedSearch');
    
    function filterWatchedStudents() {
      const searchTerm = watchedSearchInput.value.toLowerCase().trim();
      const watchedRows = document.querySelectorAll('#watched-table tbody tr');
      
      watchedRows.forEach(row => {
        const studentCode = row.children[2].textContent.toLowerCase(); // Column index 2 for student code
        const phoneNumber = row.children[4].textContent.toLowerCase(); // Column index 4 for phone
        const parentPhone = row.children[5].textContent.toLowerCase(); // Column index 5 for parent phone
        
        if (searchTerm === '' || 
            studentCode.includes(searchTerm) || 
            phoneNumber.includes(searchTerm) || 
            parentPhone.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    watchedSearchInput.addEventListener('input', filterWatchedStudents);
    
    clearWatchedSearchBtn.addEventListener('click', function() {
      watchedSearchInput.value = '';
      filterWatchedStudents();
      watchedSearchInput.focus();
    });
    
    // Search functionality for unwatched students
    const unwatchedSearchInput = document.getElementById('unwatchedSearch');
    const clearUnwatchedSearchBtn = document.getElementById('clearUnwatchedSearch');
    
    function filterUnwatchedStudents() {
      const searchTerm = unwatchedSearchInput.value.toLowerCase().trim();
      const unwatchedRows = document.querySelectorAll('#unwatched-table tbody tr');
      
      unwatchedRows.forEach(row => {
        const studentCode = row.children[2].textContent.toLowerCase(); // Column index 2 for student code
        const phoneNumber = row.children[4].textContent.toLowerCase(); // Column index 4 for phone
        const parentPhone = row.children[5].textContent.toLowerCase(); // Column index 5 for parent phone
        
        if (searchTerm === '' || 
            studentCode.includes(searchTerm) || 
            phoneNumber.includes(searchTerm) || 
            parentPhone.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    unwatchedSearchInput.addEventListener('input', filterUnwatchedStudents);
    
    clearUnwatchedSearchBtn.addEventListener('click', function() {
      unwatchedSearchInput.value = '';
      filterUnwatchedStudents();
      unwatchedSearchInput.focus();
    });
    
    // Homework management functionality
    const homeworkSearchInput = document.getElementById('homeworkSearch');
    const clearHomeworkSearchBtn = document.getElementById('clearHomeworkSearch');
    
    function filterHomeworkSubmissions() {
      const searchTerm = homeworkSearchInput.value.toLowerCase().trim();
      const homeworkRows = document.querySelectorAll('#homework-table tbody tr');
      
      homeworkRows.forEach(row => {
        const studentName = row.children[1].textContent.toLowerCase();
        const studentCode = row.children[2].textContent.toLowerCase();
        
        if (searchTerm === '' || 
            studentName.includes(searchTerm) || 
            studentCode.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    if (homeworkSearchInput) {
      homeworkSearchInput.addEventListener('input', filterHomeworkSubmissions);
    }
    
    if (clearHomeworkSearchBtn) {
      clearHomeworkSearchBtn.addEventListener('click', function() {
        homeworkSearchInput.value = '';
        filterHomeworkSubmissions();
        homeworkSearchInput.focus();
      });
    }
    
    // Export homework to Excel
    if (document.getElementById('exportHomeworkBtn')) {
      document.getElementById('exportHomeworkBtn').addEventListener('click', function() {
        exportTableToExcel('homework-table', 'homework_submissions_<%= video._id %>');
      });
    }
    
    // Homework approval/rejection functionality
    document.addEventListener('click', function(e) {
      if (e.target.closest('.approve-homework')) {
        const button = e.target.closest('.approve-homework');
        const submissionId = button.getAttribute('data-submission-id');
        const studentName = button.getAttribute('data-student-name');
        const studentId = button.getAttribute('data-student-id');
        
        if (confirm(`هل أنت متأكد من قبول واجب ${studentName}؟`)) {
          approveHomework(submissionId, studentId, studentName);
        }
      }
      
      if (e.target.closest('.reject-homework')) {
        const button = e.target.closest('.reject-homework');
        const submissionId = button.getAttribute('data-submission-id');
        const studentName = button.getAttribute('data-student-name');
        const studentId = button.getAttribute('data-student-id');
        
        const reviewNotes = prompt(`يرجى كتابة سبب رفض الواجب للطالب ${studentName}:`);
        if (reviewNotes !== null) {
          rejectHomework(submissionId, studentId, studentName, reviewNotes);
        }
      }
      
      if (e.target.closest('.review-homework')) {
        const button = e.target.closest('.review-homework');
        const submissionId = button.getAttribute('data-submission-id');
        const currentNotes = button.getAttribute('data-current-notes') || '';
        
        const newNotes = prompt('ملاحظات المراجعة:', currentNotes);
        if (newNotes !== null) {
          updateReviewNotes(submissionId, newNotes);
        }
      }
      
      if (e.target.closest('.view-homework-details')) {
        const button = e.target.closest('.view-homework-details');
        const submissionId = button.getAttribute('data-submission-id');
        viewHomeworkDetails(submissionId);
      }
    });
    
    function approveHomework(submissionId, studentId, studentName) {
      fetch(`/teacher/homework/approve/${submissionId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ studentId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('تم قبول الواجب بنجاح');
          location.reload();
        } else {
          alert('حدث خطأ: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء قبول الواجب');
      });
    }
    
    function rejectHomework(submissionId, studentId, studentName, reviewNotes) {
      fetch(`/teacher/homework/reject/${submissionId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ studentId, reviewNotes })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('تم رفض الواجب');
          location.reload();
        } else {
          alert('حدث خطأ: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء رفض الواجب');
      });
    }
    
    function updateReviewNotes(submissionId, reviewNotes) {
      fetch(`/teacher/homework/review-notes/${submissionId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ reviewNotes })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('تم تحديث ملاحظات المراجعة');
          location.reload();
        } else {
          alert('حدث خطأ: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء تحديث الملاحظات');
      });
    }
    
    function viewHomeworkDetails(submissionId) {
      fetch(`/teacher/homework/details/${submissionId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const submission = data.submission;
          
          // Create modal content
          let modalContent = `
            <div class="modal-overlay show" id="homeworkDetailsModal">
              <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                  <h3 class="modal-title">تفاصيل الواجب - ${submission.studentName}</h3>
                  <button class="modal-close" onclick="closeHomeworkDetailsModal()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="modal-body">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                      <p><strong>اسم الطالب:</strong> ${submission.studentName}</p>
                      <p><strong>الكود:</strong> ${submission.studentCode}</p>
                      <p><strong>الصف:</strong> ${submission.studentGrade}</p>
                    </div>
                    <div>
                      <p><strong>تاريخ التسليم:</strong> ${new Date(submission.submittedAt).toLocaleString('ar-EG')}</p>
                      <p><strong>الحالة:</strong> 
                        <span class="status-badge ${submission.status === 'approved' ? 'active' : submission.status === 'pending' ? 'pending' : 'rejected'}">
                          ${submission.status === 'approved' ? 'مقبول' : submission.status === 'pending' ? 'في الانتظار' : 'مرفوض'}
                        </span>
                      </p>
                    </div>
                  </div>
                  
                  ${submission.notes ? `
                    <div style="margin-bottom: 1.5rem;">
                      <h4>ملاحظات الطالب:</h4>
                      <p style="padding: 1rem; background: var(--surface-color); border-radius: var(--radius-md);">${submission.notes}</p>
                    </div>
                  ` : ''}
                  
                  ${submission.files && submission.files.length > 0 ? `
                    <div style="margin-bottom: 1.5rem;">
                      <h4>الملفات المرفقة:</h4>
                      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${submission.files.map(file => `
                          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--surface-color); border-radius: var(--radius-md);">
                            <i class="fas fa-file" style="color: var(--primary-color);"></i>
                            <span>${file.name}</span>
                            <span style="color: var(--text-secondary); font-size: 0.875rem;">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                            <a href="${file.url}" target="_blank" class="btn btn-sm btn-outline" style="margin-left: auto;">
                              <i class="fas fa-download"></i> تحميل
                            </a>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                  
                  ${submission.reviewNotes ? `
                    <div style="margin-bottom: 1.5rem;">
                      <h4>ملاحظات المراجعة:</h4>
                      <p style="padding: 1rem; background: var(--surface-color); border-radius: var(--radius-md);">${submission.reviewNotes}</p>
                    </div>
                  ` : ''}
                </div>
                <div class="modal-footer">
                  <button class="btn btn-outline" onclick="closeHomeworkDetailsModal()">إغلاق</button>
                </div>
              </div>
            </div>
          `;
          
          // Add modal to page
          document.body.insertAdjacentHTML('beforeend', modalContent);
        } else {
          alert('حدث خطأ: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء تحميل تفاصيل الواجب');
      });
    }
    
    function closeHomeworkDetailsModal() {
      const modal = document.getElementById('homeworkDetailsModal');
      if (modal) {
        modal.remove();
      }
    }
  </script>
</body>
</html> 